//===- H2BLB64FastISel.cpp - H2BLB FastISel implementation ----------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file defines the H2BLB-specific support for the FastISel class. Some
// of the target-specific code is generated by tablegen in the file
// H2BLBGenFastISel.inc, which is #included here.
//
//===----------------------------------------------------------------------===//

#include "H2BLB.h" // For the declaration of H2BLB::createFastISel.
#include "H2BLBInstrInfo.h"
#include "llvm/CodeGen/FastISel.h"
#include "llvm/CodeGen/FunctionLoweringInfo.h"

using namespace llvm;

namespace {

class H2BLBFastISel final : public FastISel {
private:
  // Selection routines.
  bool selectRet(const Instruction &I);

public:
  // Backend specific FastISel code.
  explicit H2BLBFastISel(FunctionLoweringInfo &FuncInfo,
                         const TargetLibraryInfo *LibInfo)
      : FastISel(FuncInfo, LibInfo, /*SkipTargetIndependentISel=*/true) {}

  bool fastSelectInstruction(const Instruction *I) override;

#include "H2BLBGenFastISel.inc"
};
} // end anonymous namespace.

bool H2BLBFastISel::fastSelectInstruction(const Instruction *I) {
  // Skip FastISel is we've been told so.
  if (TLI.fallBackToDAGISel(*I))
    return false;

  switch (I->getOpcode()) {
  default:
    break;
  case Instruction::Ret:
    return selectRet(*I);
  }

  // fall-back to target-independent instruction selection.
  return selectOperator(I, I->getOpcode());
}

bool H2BLBFastISel::selectRet(const Instruction &I) {
  if (!FuncInfo.CanLowerReturn)
    return false;

  const Function &F = *I.getParent()->getParent();

  // Give up on anything fancy.
  if (F.isVarArg())
    return false;
  if (TLI.supportSplitCSR(FuncInfo.MF))
    return false;

  const ReturnInst &Ret = cast<ReturnInst>(I);
  if (Ret.getNumOperands() > 0)
    return false;

  BuildMI(*FuncInfo.MBB, FuncInfo.InsertPt, MIMD, TII.get(H2BLB::RETURN));
  return true;
}

FastISel *H2BLB::createFastISel(FunctionLoweringInfo &FuncInfo,
                                const TargetLibraryInfo *LibInfo) {

  return new H2BLBFastISel(FuncInfo, LibInfo);
}
